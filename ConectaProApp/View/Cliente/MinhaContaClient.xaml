<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ConectaProApp.View.Cliente.MinhaContaClient"
             BackgroundColor="#f1f1f1">

    <ScrollView>
        <VerticalStackLayout>
            <!-- Cabeçalho Azul -->
            <Grid BackgroundColor="#0f5cc2" HeightRequest="58" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Image Source="conectapro_logo.png" HeightRequest="40" VerticalOptions="Center" Grid.Column="0" />

                <Frame HeightRequest="40" WidthRequest="40"
       CornerRadius="20"
       HasShadow="False"
       Padding="0"
       BackgroundColor="White"
       BorderColor="#0f5cc2"
       VerticalOptions="Center"
       HorizontalOptions="End"
       Grid.Column="2">
                    <Image Source="empresasemfoto.png" 
           Aspect="AspectFill" 
           HeightRequest="40" WidthRequest="40"
           >
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnFotoEmpresaClicked"/>
                        </Image.GestureRecognizers>
                        <Image.Clip>
                            <EllipseGeometry 
                Center="20,20"
                RadiusX="20"
                RadiusY="20"/>
                        </Image.Clip>
                    </Image>
                </Frame>
            </Grid>

            <!-- Banner/Header -->
            <!-- Banner/Header -->
            <Grid HeightRequest="210">

                <!-- Header com clique separado -->
                <Grid>
                    <Image x:Name="headerClienteImage"
               Source="{Binding FotoVMHeader.FonteImagem}"
               Aspect="AspectFill"
               HeightRequest="150"
               HorizontalOptions="Fill"
               VerticalOptions="Start" />

                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding FotoVMHeader.SelecionarFotoCommand}" />
                    </Grid.GestureRecognizers>
                </Grid>

                <!-- Avatar circular sobreposto -->
                <Grid HeightRequest="120" WidthRequest="120"
          VerticalOptions="Start"
          HorizontalOptions="Center"
          Margin="0,120,0,0"
          ZIndex="10"
          IsClippedToBounds="True">

                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding FotoVMAvatar.SelecionarFotoCommand}" />
                    </Grid.GestureRecognizers>

                    <!-- Círculo de recorte -->
                    <Grid.Clip>
                        <EllipseGeometry Center="60,60" RadiusX="60" RadiusY="60" />
                    </Grid.Clip>

                    <!-- Imagem de perfil (avatar) -->
                    <Image x:Name="avatarImageClient"
               Source="empresasemfoto.png"
               WidthRequest="120"
               HeightRequest="120"
               Aspect="AspectFill"
               HorizontalOptions="Center"
               VerticalOptions="Center" />
                </Grid>
            </Grid>

            <!-- Nome e descrição -->
            <VerticalStackLayout Padding="20,0" Spacing="5" HorizontalOptions="Center">
                <Label Text="{Binding NomeEmpresa, Mode=OneWay}"
                           FontAttributes="Bold"
                           FontSize="20"
                           HorizontalTextAlignment="Center"
                           TextColor="Black" />      
                
                <Editor x:Name="DescricaoEditor"
                        TextColor="Black"
                        Placeholder="Sobre o cliente"
                        FontSize="14"
                        AutoSize="TextChanges"
                        WidthRequest="250"
                        TextChanged="OnDescricaoChanged"
                        Margin="0,0,0,10"
                        HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- Abas -->
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="18" Padding="10">
                <Button Text="Solicitações"
        BackgroundColor="#0f5cc2" TextColor="White"
        CornerRadius="20" WidthRequest="110"
        Command="{Binding SelecionarAbaCommand}"
        CommandParameter="SolicitacaoCliente" />
                <Button Text="Propostas" BackgroundColor="#0f5cc2" TextColor="White"
                        CornerRadius="20" WidthRequest="110"
                        Command="{Binding SelecionarAbaCommand}" CommandParameter="PropostasRecebidas" />
                <Button Text="Serviços" BackgroundColor="#0f5cc2" TextColor="White"
                        CornerRadius="20" WidthRequest="110"
                        Command="{Binding SelecionarAbaCommand}" CommandParameter="HistoricoCliente" />
            </HorizontalStackLayout>

            <!-- Listas -->


            <CollectionView x:Name="PropostasClienteView"
    ItemsSource="{Binding PropostaCliente}"
    Margin="15,10"
    IsVisible="{Binding PropostasClienteVisivel}">

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame CornerRadius="15" BorderColor="#DDDDDD" Padding="15" Margin="0,10" BackgroundColor="White" HasShadow="True">
                            <VerticalStackLayout Spacing="12">

                                <!-- Título -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding TituloServico}" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#222222" />
                                    
                                </Grid>

                                <!-- Urgência e Forma de Pagamento -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Label Text="{Binding NvlUrgenciaEnum}" 
                               FontSize="14" 
                               TextColor="#FF3B30" />
                                    <Label Text="{Binding FormaPagtoEnum, TargetNullValue='Sem Pagamento'}" 
                               FontSize="14" 
                               TextColor="#333333" 
                               HorizontalOptions="End" />
                                </Grid>

                                <!-- Valor -->
                                <Label Text="{Binding ValorContratacao, StringFormat='VALOR: R$ {0:N2}'}"
                           FontSize="14"
                           TextColor="#333333" />

                                <!-- Datas -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Label Text="{Binding PrevisaoInicio, StringFormat='INÍCIO: {0:dd/MM/yyyy}'}" 
                               FontSize="14" 
                               TextColor="#333333" />
                                    <Label Text="{Binding DataFinalizacao, StringFormat='FIM: {0:dd/MM/yyyy}'}" 
                               FontSize="14" 
                               TextColor="#333333"
                               HorizontalOptions="End" />
                                </Grid>

                                <!-- Cliente -->
                                <Label Text="{Binding EmpresaClienteResumoDTO.NomeFantasia, StringFormat='CLIENTE: {0}'}"
                           FontSize="14"
                           TextColor="#333333" />

                                <!-- Botões -->
                                <HorizontalStackLayout HorizontalOptions="End" Spacing="20" Margin="0,10,0,0">
                                    <Button Text="ACEITAR"
                            BackgroundColor="White" 
                            BorderColor="Green" 
                            TextColor="Green" 
                            BorderWidth="1"
                            CornerRadius="8"
                            Command="{Binding BindingContext.AceitarSolicitacaoCommand, Source={x:Reference PropostasClienteView}}"
                            CommandParameter="{Binding IdSolicitacao}" />

                                    <Button Text="RECUSAR"
                            BackgroundColor="White" 
                            BorderColor="Red" 
                            TextColor="Red" 
                            BorderWidth="1"
                            CornerRadius="8"
                            Command="{Binding BindingContext.RecusarSolicitacaoCommand, Source={x:Reference PropostasClienteView}}"
                            CommandParameter="{Binding IdSolicitacao}" />
                                </HorizontalStackLayout>

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>





            <!-- Lista de Histórico -->
            <CollectionView x:Name="HistoricoView"
     ItemsSource="{Binding HistoricoCliente}" 
     Margin="10" SelectionMode="None" 
     IsVisible="{Binding HistoricoClienteVisivel}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,5" Padding="10" BackgroundColor="#FFFFFF" CornerRadius="10" BorderColor="#CCCCCC" HasShadow="True">
                            <VerticalStackLayout Spacing="10">

                                <!-- Título + Bolinha verde -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding TituloServico}" FontAttributes="Bold" FontSize="18" TextColor="#000000" />
                                    <Frame BackgroundColor="Green" WidthRequest="12" HeightRequest="12" CornerRadius="6" VerticalOptions="Center" HorizontalOptions="End" Padding="0" />
                                </Grid>

                                <!-- Status e Satisfação -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="STATUS: " />
                                                <Span Text="{Binding StatusAmigavel}" TextColor="Green" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <Label Grid.Column="1">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="SATISFAÇÃO: " />
                                                <Span Text="Satisfeito" TextColor="#1e88e5" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>

                                <!-- Valor e Categoria -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="VALOR: " />
                                                <Span Text="{Binding ValorContratacao, StringFormat='R$ {0:N2}'}" TextColor="Black" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <Label Grid.Column="1">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="CATEGORIA: " />
                                                <Span Text="{Binding TipoCategoriaEnum}" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>

                                <!-- Prestador -->
                                <Label Text="{Binding PrestadorResumoDTO.Nome, StringFormat='REALIZADO POR: {0}'}" FontSize="13" FontAttributes="Bold" TextColor="#000000" />

                                <!-- Botão de Pagamento -->
                                <HorizontalStackLayout HorizontalOptions="End" Spacing="18" Padding="10">
                                    <Button Text="Pagar" BackgroundColor="Orange" TextColor="White"
                     CornerRadius="20" WidthRequest="110"
                     Command="{Binding BindingContext.PagarServicoCommand, Source={x:Reference HistoricoView}}"
                     CommandParameter="{Binding IdServico}" />


                           
                                </HorizontalStackLayout>

                                <HorizontalStackLayout Grid.Row="3" Grid.ColumnSpan="2" HorizontalOptions="End" Spacing="15" Margin="0,10,0,0">
                                    <Button Text="FINALIZAR"
                                    TextColor="Green"
                                    BackgroundColor="White"
                                    FontAttributes="Bold"
                                    Command="{Binding BindingContext.ConfirmarFinalizacaoServicoCommand, Source={x:Reference HistoricoView}}"
                                    CommandParameter="{Binding IdServico}" />
                                    


                                </HorizontalStackLayout>

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!--Lista de Solicitações do Cliente -->
            <CollectionView x:Name="SolicitacoesClienteView"
                ItemsSource="{Binding SolicitacaoCliente}"
                Margin="15,10"
                IsVisible="{Binding SolicitacaoClienteVisivel}">

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame CornerRadius="15" BorderColor="#DDDDDD" Padding="15" Margin="0,10" BackgroundColor="White" HasShadow="True">
                            <VerticalStackLayout Spacing="12">

                                <!-- Título -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding TituloSolicitacao}" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#222222" />
                                </Grid>

                                <!-- Status e Urgência -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Label Text="{Binding StatusSolicitacao}" 
                               FontSize="14" 
                               TextColor="#FF9500" />
                                    <Label Text="{Binding NvlUrgencia}" 
                               FontSize="14" 
                               TextColor="#007AFF" 
                               HorizontalOptions="End" />
                                </Grid>

                                <!-- Valor -->
                                <Label Text="{Binding ValorProposto, StringFormat='VALOR: R$ {0}'}"
                           FontSize="14"
                           TextColor="#333333" />

                                <!-- Categoria -->
                                <Label Text="{Binding TipoCategoria, TargetNullValue='SEM CATEGORIA'}" 
                           FontSize="14" 
                           TextColor="#333333" />

                                <!-- Datas -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Label Text="{Binding PrevisaoInicio, StringFormat='INÍCIO: {0}'}" 
                               FontSize="14" 
                               TextColor="#333333" />
                                    <Label Text="{Binding DuracaoServico, StringFormat='DURAÇÃO: {0} dias'}" 
                               FontSize="14" 
                                           
                               TextColor="#333333"
                                HorizontalOptions="End"
                                HorizontalTextAlignment="End"
                                Margin="0,0,1000,0"/>
                                </Grid>

                                <!-- Cliente -->
                                <Label Text="{Binding EmpresaClienteResumoDTO.NomeFantasia, StringFormat='CLIENTE: {0}'}"
                           FontSize="14"
                           TextColor="#333333" />

                                <!-- Botões -->
                                <HorizontalStackLayout HorizontalOptions="End" Spacing="20" Margin="0,10,0,0">
                                    <Button Text="EDITAR"
                                BackgroundColor="White" 
                                BorderColor="#0f5cc2" 
                                TextColor="#0f5cc2" 
                                BorderWidth="1"
                                CornerRadius="8"
                                Command="{Binding BindingContext.EditarSolicitacaoCommand, Source={x:Reference SolicitaoesClienteView}}"
                                CommandParameter="{Binding IdSolicitacao}" />

                                    <Button Text="REMOVER"
                                BackgroundColor="White" 
                                BorderColor="Red" 
                                TextColor="Red" 
                                BorderWidth="1"
                                CornerRadius="8"
                                Command="{Binding BindingContext.RemoverSolicitacaoCommand, Source={x:Reference SolicitaoesClienteView}}"
                                CommandParameter="{Binding IdSolicitacao}" />
                                </HorizontalStackLayout>

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>







        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
