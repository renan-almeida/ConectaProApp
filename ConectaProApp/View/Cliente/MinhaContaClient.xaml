<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ConectaProApp.View.Cliente.MinhaContaClient"
             BackgroundColor="#f1f1f1">

    <ScrollView>
        <VerticalStackLayout>
            <!-- Cabeçalho Azul -->
            <Grid BackgroundColor="#0f5cc2" HeightRequest="58" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Image Source="conectapro_logo.png" HeightRequest="40" VerticalOptions="Center" Grid.Column="0" />

                <Frame HeightRequest="40" WidthRequest="40"
       CornerRadius="20"
       HasShadow="False"
       Padding="0"
       BackgroundColor="White"
       BorderColor="#0f5cc2"
       VerticalOptions="Center"
       HorizontalOptions="End"
       Grid.Column="2">
                    <Image Source="{Binding FotoEmpresaUrl}" 
           Aspect="AspectFill" 
           HeightRequest="40" WidthRequest="40"
           >
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnFotoEmpresaClicked"/>
                        </Image.GestureRecognizers>
                        <Image.Clip>
                            <EllipseGeometry 
                Center="20,20"
                RadiusX="20"
                RadiusY="20"/>
                        </Image.Clip>
                    </Image>
                </Frame>
            </Grid>

            <!-- Banner/Header -->
            <!-- Banner/Header -->
            <Grid HeightRequest="210">

                <!-- Header com clique separado -->
                <Grid>
                    <Image x:Name="headerClienteImage"
               Source="{Binding FotoVMHeader.FonteImagem}"
               Aspect="AspectFill"
               HeightRequest="150"
               HorizontalOptions="Fill"
               VerticalOptions="Start" />

                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding FotoVMHeader.SelecionarFotoCommand}" />
                    </Grid.GestureRecognizers>
                </Grid>

                <!-- Avatar circular sobreposto -->
                <Grid HeightRequest="120" WidthRequest="120"
          VerticalOptions="Start"
          HorizontalOptions="Center"
          Margin="0,120,0,0"
          ZIndex="10"
          IsClippedToBounds="True">

                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding FotoVMAvatar.SelecionarFotoCommand}" />
                    </Grid.GestureRecognizers>

                    <!-- Círculo de recorte -->
                    <Grid.Clip>
                        <EllipseGeometry Center="60,60" RadiusX="60" RadiusY="60" />
                    </Grid.Clip>

                    <!-- Imagem de perfil (avatar) -->
                    <Image x:Name="avatarImageClient"
               Source="{Binding FotoVMAvatar.FonteImagem}"
               WidthRequest="120"
               HeightRequest="120"
               Aspect="AspectFill"
               HorizontalOptions="Center"
               VerticalOptions="Center" />
                </Grid>
            </Grid>

            <!-- Nome e descrição -->
            <VerticalStackLayout Padding="20,0" Spacing="5" HorizontalOptions="Center">
                <Entry x:Name="NomeEntry"
                       TextColor="Black"
                       Placeholder="Nome do Cliente"
                       FontAttributes="Bold"
                       FontSize="20"
                       Margin="20"
                       HorizontalTextAlignment="Center"
                       WidthRequest="250"
                       TextChanged="OnNomeChanged" />
                <Editor x:Name="DescricaoEditor"
                        TextColor="Black"
                        Placeholder="Sobre o cliente"
                        FontSize="14"
                        AutoSize="TextChanges"
                        WidthRequest="250"
                        TextChanged="OnDescricaoChanged"
                        Margin="0,0,0,10"
                        HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- Abas -->
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="18" Padding="10">
                <Button Text="Solicitações" BackgroundColor="#0f5cc2" TextColor="White"
                        CornerRadius="20" WidthRequest="110"
                        Command="{Binding SelecionarAbaCommand}" CommandParameter="SolicitacoesCliente" />
                <Button Text="Propostas" BackgroundColor="#0f5cc2" TextColor="White"
                        CornerRadius="20" WidthRequest="110"
                        Command="{Binding SelecionarAbaCommand}" CommandParameter="PropostasRecebidas" />
                <Button Text="Serviços" BackgroundColor="#0f5cc2" TextColor="White"
                        CornerRadius="20" WidthRequest="110"
                        Command="{Binding SelecionarAbaCommand}" CommandParameter="HistoricoCliente" />
            </HorizontalStackLayout>

            <!-- Listas -->
            

            <!-- Propostas do Cliente -->
            <CollectionView x:Name="PropostasRecebidasView"
    ItemsSource="{Binding PropostasRecebidas}"
    Margin="15,10"
    IsVisible="{Binding PropostasRecebidasVisivel}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame CornerRadius="10" BorderColor="Gray" Padding="10" Margin="0,5" BackgroundColor="White">
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto">

                                <!-- Avatar -->
                                <Frame HeightRequest="50" WidthRequest="50" CornerRadius="25"
               BackgroundColor="#f1f1f1" VerticalOptions="Start" Padding="0">
                                    <Image Source="avatar_padrao.png" Aspect="AspectFill" />
                                </Frame>

                                <!-- Nome do prestador -->
                                <Label Grid.Column="1" Text="{Binding PrestadorResumoDTO.Nome}" 
               FontAttributes="Bold" FontSize="16" TextColor="Black" VerticalOptions="Center"/>

                                <!-- Serviço + Orçamento + Forma Pagto -->
                                <Grid Grid.Row="1" Grid.ColumnSpan="2" Margin="0,10,0,0">
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">

                                        <Label Grid.Row="0" Grid.Column="0" Text="{Binding TituloServico}" 
                       FontAttributes="Bold" FontSize="14" TextColor="Black"/>

                                        <Label Grid.Row="1" Grid.Column="0" Text="{Binding ValorContratacao, StringFormat='ORÇAMENTO: R$ {0:F2}'}" 
                       FontSize="12" TextColor="Black" />

                                        <Label Grid.Row="1" Grid.Column="1" 
                       Text="{Binding FormaPagtoEnum}" 
                       FontSize="12" TextColor="Black" HorizontalOptions="End"/>

                                    </Grid>
                                </Grid>

                                <!-- Datas -->
                                <Grid Grid.Row="2" Grid.ColumnSpan="2" Margin="0,5,0,0">
                                    <Grid ColumnDefinitions="*,*" >
                                        <Label Grid.Column="0" Text="{Binding PrevisaoInicio, StringFormat='DATA INICIO: {0}'}" FontSize="12" TextColor="Black"/>
                                        <Label Grid.Column="1" Text="{Binding DataFinalizacao, StringFormat='DATA FIM: {0:dd/MM}'}" 
                       FontSize="12" TextColor="Black" HorizontalOptions="End"/>
                                    </Grid>
                                </Grid>

                                <!-- Botões Aceitar/Recusar -->
                                <HorizontalStackLayout Grid.Row="3" Grid.ColumnSpan="2" HorizontalOptions="End" Spacing="15" Margin="0,10,0,0">
                                    <Button Text="ACEITAR"
                    TextColor="Green"
                    FontAttributes="Bold"
                    Command="{Binding BindingContext.AceitarSolicitacaoCommand, Source={x:Reference PropostasRecebidasView}}"
                    CommandParameter="{Binding IdSolicitacao}" />
                                    <Button Text="RECUSAR"
                    TextColor="Red"
                    FontAttributes="Bold"
                    Command="{Binding BindingContext.RecusarSolicitacaoCommand, Source={x:Reference PropostasRecebidasView}}"
                    CommandParameter="{Binding IdSolicitacao}" />
                                </HorizontalStackLayout>

                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>


            <!-- Lista de Histórico -->
            <CollectionView ItemsSource="{Binding HistoricoCliente}" Margin="10" SelectionMode="None" IsVisible="{Binding HistoricoClienteVisivel}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,5" Padding="10" BackgroundColor="#FFFFFF" CornerRadius="10" BorderColor="#CCCCCC" HasShadow="True">
                            <VerticalStackLayout Spacing="10">

                                <!-- Título + Bolinha verde -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding TituloServico}" FontAttributes="Bold" FontSize="18" TextColor="#000000" />
                                    <Frame BackgroundColor="Green" WidthRequest="12" HeightRequest="12" CornerRadius="6" VerticalOptions="Center" HorizontalOptions="End" Padding="0" />
                                </Grid>

                                <!-- Status e Satisfação -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="STATUS: " />
                                                <Span Text="{Binding StatusAmigavel}" TextColor="Green" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <Label Grid.Column="1">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="SATISFAÇÃO: " />
                                                <Span Text="Satisfeito" TextColor="#1e88e5" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>

                                <!-- Valor e Categoria -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label>
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="VALOR: " />
                                                <Span Text="{Binding ValorContratacao, StringFormat='R$ {0:N2}'}" TextColor="Black" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <Label Grid.Column="1">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="CATEGORIA: " />
                                                <Span Text="{Binding TipoCategoriaEnum}" FontAttributes="Bold" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>

                                <!-- Prestador -->
                                <Label Text="{Binding PrestadorResumoDTO.Nome, StringFormat='REALIZADO POR: {0}'}" FontSize="13" FontAttributes="Bold" TextColor="#000000" />

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!--Lista de Solicitações do Cliente -->
            <CollectionView x:Name="SolicitacoesClienteView"
    ItemsSource="{Binding SolicitacoesRecebidas}"
    Margin="15,10"
    IsVisible="{Binding SolicitacoesClienteVisivel}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame CornerRadius="10" BorderColor="Gray" Padding="10" Margin="0,5" BackgroundColor="White">
                            <VerticalStackLayout Spacing="5">

                                <!-- Título -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding TituloServico}" FontAttributes="Bold" FontSize="16" TextColor="Black" />
                                    <Ellipse WidthRequest="10" HeightRequest="10" Fill="Orange" VerticalOptions="Center" />
                                </Grid>

                                <!-- Status e Urgência -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label Text="{Binding StatusAmigavel}" FontSize="12" TextColor="Orange" />
                                    <Label Text="{Binding NvlUrgenciaEnum}" FontSize="12" TextColor="Blue" HorizontalOptions="End" />
                                </Grid>

                                <!-- Valor e Categoria -->
                                <Grid ColumnDefinitions="*,*">
                                    <Label Text="{Binding ValorProposto, StringFormat='VALOR: R$ {0:F2}'}" FontSize="12" TextColor="Black" />
                                    <Label Text="{Binding TipoCategoriaEnum}" FontSize="12" TextColor="Black" HorizontalOptions="End" />
                                </Grid>

                                <!-- Propostas -->
                                <Label Text="{Binding QtdPropostas, StringFormat='PROPOSTAS: {0}'}" FontSize="12" TextColor="Black" />

                                <!-- Botões Editar e Remover -->
                                <HorizontalStackLayout HorizontalOptions="End" Spacing="20">
                                    <Label Text="EDITAR" TextColor="Orange" FontAttributes="Bold">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding BindingContext.EditarSolicitacaoCommand, Source={x:Reference SolicitacoesClienteView}}"
                                          CommandParameter="{Binding IdSolicitacao}" />
                                        </Label.GestureRecognizers>
                                    </Label>

                                    <Label Text="REMOVER" TextColor="Red" FontAttributes="Bold">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding BindingContext.RemoverSolicitacaoCommand, Source={x:Reference SolicitacoesClienteView}}"
                                          CommandParameter="{Binding IdSolicitacao}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </HorizontalStackLayout>

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>



        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
